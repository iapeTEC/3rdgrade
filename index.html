<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Module 4 â€“ Scientific Report (First Draft)</title>
  <style>
    /* THEME */
    :root{
      --bg:#ffffff; --card:#ffffff; --text:#0b1220; --muted:#6b7280;
      --accent:#1f6feb; --ok:#16a34a; --warn:#b45309; --bad:#dc2626;
      --border:rgba(0,0,0,.12); --shadow:rgba(0,0,0,.08);
      --hint:#eef2ff;
    }
    html[data-theme="dark"]{
      --bg:#000; --card:#0b0b0f; --text:#f5f7ff; --muted:#a3a7b7;
      --accent:#7c9bff; --ok:#22c55e; --warn:#ffb02e; --bad:#ff6b6b;
      --border:rgba(255,255,255,.14); --shadow:rgba(0,0,0,.55);
      --hint:#0f1328;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    html[data-theme="dark"] header{background:rgba(0,0,0,.7)}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:clamp(22px,2.6vw,32px)}
    .sub{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-top:10px}
    input[type=text]{background:transparent;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px;outline:none}
    input[type=text]::placeholder{color:var(--muted)}
    button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px var(--shadow)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .icon-btn{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:999px}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;font-size:12px}
    .grid{display:grid;gap:16px}
    @media(min-width:880px){ .grid-2{grid-template-columns:1fr 1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 8px 30px var(--shadow)}
    .card h3{margin:0 0 8px;font-size:18px}
    .muted{color:var(--muted)}
    .hint{background:var(--hint);border:1px solid var(--border);padding:12px;border-radius:12px;color:var(--text)}
    .section{display:flex;flex-direction:column;gap:8px}
    .label{font-weight:700}
    textarea{
      min-height:120px;width:100%;resize:vertical;background:transparent;
      border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;outline:none
    }
    .small{font-size:12px}
    footer{border-top:1px solid var(--border);margin-top:24px;padding:20px;color:var(--muted)}
    .strike{opacity:.5;filter:grayscale(.3)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h1>Module 4 â€“ Scientific Report (First Draft)</h1>
          <div class="sub">Introduction â€¢ Methods â€¢ Results â€¢ Discussion â€¢ Conclusion</div>
        </div>
        <button id="themeToggle" class="icon-btn">ðŸŒ“ Theme</button>
      </div>

      <div class="bar">
        <div class="row">
          <input id="studentName" type="text" placeholder="Full name" autocomplete="name" />
          <span class="pill"><strong>Time:</strong> <span id="timer" class="timer">30:00</span></span>
          <span id="focusFlag" class="badge">Focus OK</span>
          <span id="tabCount" class="badge">Tab: 0</span>
        </div>
        <div class="row">
          <input id="testId" type="text" value="Module4-Scientific-Report-Draft-v1" />
          <button id="startBtn">Start Writing</button>
          <button id="submitBtn" disabled>Submit Draft</button>
        </div>
      </div>

      <div class="hint small">
        Keep this tab open. Auto-submit at 30:00. Copy/Find and tab switches are recorded.
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Scaffolding -->
    <section class="card">
      
    </section>

    <!-- Writing form -->
    <form id="draftForm" class="grid" autocomplete="off" style="margin-top:16px">
      

      <section class="card section">
        <div class="label">Explique com suas palavras, o que eh um Grid e um Span e a diferenca entre eles:</div>
        <textarea id="t_intro" placeholder="The aim of this research isâ€¦ This topic is important becauseâ€¦"></textarea>
        <div class="small muted" id="wc_intro">Words: 0</div>
      </section>

    

    <section class="card">
      <h3>Results & Admin</h3>
      <p class="muted small">Teacher only.</p>
      <div class="row" style="margin-top:10px">
        <button id="downloadCsvBtn" disabled>Download CSV</button>
        <button id="resetBtn" class="icon-btn">Reset</button>
      </div>
    </section>

    <footer>
      <div class="small">Traine</div>
    </footer>
  </main>

  <script>
    // ===== Theme toggle =====
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme') || 'light';
      root.setAttribute('data-theme', saved);
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      });
    })();

    // ===== Config =====
    const DEFAULT_MINUTES = 30;
    // >>> Troque aqui se precisar apontar para outro deploy <<<
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyvmVTcmjumr5uAGS7W-NWW5LRlRflUCvnkgk37kZqaBhSHcjjM1y84bk_B38NkFpnGaw/exec';

    // ===== State =====
    let started = false, ended = false;
    let startTime = null, timerInterval = null;
    let secondsLeft = DEFAULT_MINUTES * 60;

    // Focus/anti-cheat
    let tabSwitches = 0, blurCount = 0, isBlurred = false, blurStart = null, totalBlurMs = 0;
    let copyCount = 0, pasteCount = 0, findCount = 0;

    // DOM
    const startBtn = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const timerEl = document.getElementById('timer');
    const nameInput = document.getElementById('studentName');
    const testIdInput = document.getElementById('testId');
    const focusFlag = document.getElementById('focusFlag');
    const tabCountEl = document.getElementById('tabCount');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const resetBtn = document.getElementById('resetBtn');

    const form = document.getElementById('draftForm');
    const fields = {
      hyp: document.getElementById('t_hyp'),
      intro: document.getElementById('t_intro'),
      methods: document.getElementById('t_methods'),
      results: document.getElementById('t_results'),
      discussion: document.getElementById('t_discussion'),
      conclusion: document.getElementById('t_conclusion')
    };
    const wcEls = {
      intro: document.getElementById('wc_intro'),
      methods: document.getElementById('wc_methods'),
      results: document.getElementById('wc_results'),
      discussion: document.getElementById('wc_discussion'),
      conclusion: document.getElementById('wc_conclusion')
    };

    // Lock until start
    [...form.elements].forEach(el => el.disabled = true);

    // Word count helpers
    function countWords(s){ return (s.trim().match(/\b[\wâ€™'-]+\b/g) || []).length; }
    function updateWC(){
      wcEls.intro.textContent = 'Words: ' + countWords(fields.intro.value);
      wcEls.methods.textContent = 'Words: ' + countWords(fields.methods.value);
      wcEls.results.textContent = 'Words: ' + countWords(fields.results.value);
      wcEls.discussion.textContent = 'Words: ' + countWords(fields.discussion.value);
      wcEls.conclusion.textContent = 'Words: ' + countWords(fields.conclusion.value);
    }
    Object.values(fields).forEach(el => el.addEventListener('input', updateWC));

    function fmt(secs){
      const m = Math.floor(secs/60).toString().padStart(2,'0');
      const s = (secs%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function tick(){
      secondsLeft--; if(secondsLeft < 0) secondsLeft = 0;
      timerEl.textContent = fmt(secondsLeft);
      if(secondsLeft === 0){ autoSubmit('time'); }
    }
    function startTimer(){ clearInterval(timerInterval); timerInterval = setInterval(tick, 1000); }

    function startWriting(){
      const name = nameInput.value.trim();
      if(!name){ alert('Please enter your full name before starting.'); return; }
      started = true; startTime = new Date();
      nameInput.disabled = true; testIdInput.disabled = true;
      startBtn.disabled = true; submitBtn.disabled = false;
      [...form.elements].forEach(el => el.disabled = false);
      startTimer();
      localStorage.setItem('m4_draft_session', JSON.stringify({ts: Date.now(), name}));
    }

    function collectPayload(reason='manual'){
      const now = new Date();
      const studentNameSafe = (nameInput.value || '').trim() || '(no name)';
      // Build writing object + word counts
      const writing = {
        hypothesis: fields.hyp.value.trim(),
        introduction: fields.intro.value.trim(),
        methods: fields.methods.value.trim(),
        results: fields.results.value.trim(),
        discussion: fields.discussion.value.trim(),
        conclusion: fields.conclusion.value.trim(),
        wordCount: {
          introduction: countWords(fields.intro.value),
          methods: countWords(fields.methods.value),
          results: countWords(fields.results.value),
          discussion: countWords(fields.discussion.value),
          conclusion: countWords(fields.conclusion.value),
          total: countWords(
            [fields.hyp.value, fields.intro.value, fields.methods.value,
             fields.results.value, fields.discussion.value, fields.conclusion.value].join(' ')
          )
        },
        version: 'writing-draft-v1'
      };

      return {
        testId: (testIdInput.value.trim() || 'Module4-Scientific-Report-Draft-v1'),
        studentName: studentNameSafe,
        startISO: startTime?.toISOString() || null,
        endISO: now.toISOString(),
        durationSec: startTime ? Math.round((now - startTime)/1000) : null,
        reason,
        // keep score schema for compatibility with your sheet (zeros)
        score: {
          totalCorrect: 0, totalPossible: 0,
          byDifficulty: { easy:0, medium:0, hard:0 },
          possibleByDifficulty: { easy:0, medium:0, hard:0 }
        },
        // answers empty (writing-only page)
        answers: {},
        writing,
        focus: { tabSwitches, blurCount, totalBlurMs, copyCount, pasteCount, findCount }
      };
    }

    function toCSV(obj){
      const s = obj;
      const row = [
        new Date().toISOString(), s.testId, JSON.stringify(s.studentName), s.startISO, s.endISO, s.durationSec,
        s.score.totalCorrect, s.score.totalPossible,
        s.score.byDifficulty.easy, s.score.byDifficulty.medium, s.score.byDifficulty.hard,
        s.focus.tabSwitches, s.focus.blurCount, s.focus.totalBlurMs, s.focus.copyCount, s.focus.pasteCount, s.focus.findCount,
        JSON.stringify(s.answers), JSON.stringify(s.writing)
      ];
      const header = [
        'timestamp','testId','studentName','startISO','endISO','durationSec',
        'correct','possible','easyCorrect','mediumCorrect','hardCorrect',
        'tabSwitches','blurCount','totalBlurMs','copyCount','pasteCount','findCount',
        'answers','writing'
      ];
      return header.join(',') + '\n' + row.join(',');
    }

    async function sendResults(payload){
      try{
        const res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain' }, // CORS-friendly
          body: JSON.stringify(payload)
        });
        return { posted: res.ok, status: res.status };
      }catch(err){
        console.warn('POST failed', err);
        return { posted:false, error: String(err) };
      }
    }

    function downloadCSV(name, csv){
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${(name||'anonymous').replace(/\s+/g,'_')}_Module4_Draft.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    function lockPage(){
      [...form.elements].forEach(el => el.disabled = true);
      submitBtn.disabled = true; downloadCsvBtn.disabled = false;
      document.querySelectorAll('.card').forEach(sec => sec.classList.add('strike'));
      document.querySelector('.hint').textContent = 'Locked. Draft recorded.';
    }

    async function finalize(reason){
      if(ended) return; ended = true; clearInterval(timerInterval);
      const payload = collectPayload(reason);
      const csv = toCSV(payload);
      const postRes = await sendResults(payload);
      downloadCSV(payload.studentName || 'anonymous', csv); // free fallback
      lockPage();
      console.log('Draft payload:', payload, 'POST:', postRes);
      alert('Draft submitted.');
    }

    function autoSubmit(reason){ finalize(reason); }

    // Events
    startBtn.addEventListener('click', startWriting);
    submitBtn.addEventListener('click', () => finalize('manual'));
    downloadCsvBtn.addEventListener('click', ()=>{
      const csv = toCSV(collectPayload('download-only'));
      downloadCSV((nameInput.value || '').trim() || 'anonymous', csv);
    });
    resetBtn.addEventListener('click', ()=> location.reload());

    // Timer
    function tickTimer(){ /* already defined above */ }
    function startTimerWrapper(){ /* already defined above */ }

    // Anti-cheat
    document.addEventListener('visibilitychange', ()=>{
      if(!started || ended) return;
      if(document.visibilityState === 'hidden'){
        tabSwitches++; tabCountEl.textContent = `Tab: ${tabSwitches}`;
        focusFlag.textContent = 'Focus LOST';
        isBlurred = true; blurStart = Date.now();
      } else {
        focusFlag.textContent = 'Focus OK';
        if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
      }
    });
    window.addEventListener('blur', ()=>{
      if(!started || ended) return;
      blurCount++;
      if (document.visibilityState !== 'hidden') {
        tabSwitches++; tabCountEl.textContent = `Tab: ${tabSwitches}`;
      }
      focusFlag.textContent='Focus LOST'; isBlurred=true; blurStart=Date.now();
    });
    window.addEventListener('focus', ()=>{
      if(!started || ended) return;
      focusFlag.textContent='Focus OK';
      if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
    });
    window.addEventListener('pagehide', ()=>{
      if(!started || ended) return;
      tabSwitches++; tabCountEl.textContent = `Tab: ${tabSwitches}`;
      if(isBlurred){ totalBlurMs += Date.now() - (blurStart||Date.now()); isBlurred=false; }
    });
    document.addEventListener('copy', ()=>{ copyCount++; });
    document.addEventListener('paste', ()=>{ pasteCount++; });
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && (e.key==='f' || e.key==='F')){ findCount++; }
    });

    // Live word count init
    updateWC();

    // Timer start helper
    function startTimer(){ clearInterval(timerInterval); timerInterval = setInterval(tick, 1000); }
  </script>
</body>
</html>

